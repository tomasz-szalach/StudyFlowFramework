<!DOCTYPE html>
<html lang="pl" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta name="description" content="Manage your tasks">
    <meta name="keywords" content="tasks, todo, list">
    <title>StudyFlow</title>

    <!-- Twoje style i skrypty -->
    <link rel="stylesheet" th:href="@{/css/stylehomePage.css}" />
    <script th:src="@{/js/logout.js}" defer></script>
    <script th:src="@{/js/search.js}" defer></script>
    <script th:src="@{/js/taskList.js}" defer></script>
    <script th:src="@{/js/changePassword.js}" defer></script>
</head>
<body>
<div id="TopBar">
    <!-- Logo -->
    <img class="logo" th:src="@{/img/logo.svg}" alt="Logo">
    <div id="User-profile">
        <div class="User-profile2" onclick="logout(this)">
            <span class="Logout">Wyloguj siƒô</span>
        </div>
        <a class="User-profile2" th:href="@{/changePassword}">
            <span class="ChangePassword">Zmie≈Ñ has≈Ço</span>
        </a>
    </div>
</div>

<div id="container-page">
    <aside class="sidebar">
        <div class="tasklist-display">
            <h3>Twoje listy zada≈Ñ</h3>

            <!-- Blok z listami zada≈Ñ (taskLists) -->
            <div th:if="${taskLists != null}">
                <div th:each="taskList, iter : ${taskLists}">
                    <div class="home-blocks">
                        <a class="TASKLIST"
                           th:classappend="${iter.index} == 0 ? ' selected' : ''"
                           href="#"
                           th:attr="data-tasklist-id=${taskList.id}">
                            <div class="TASKLIST-choose">
                                <span class="tasklist-icon">&#x1F4CB;</span>
                                <div class="name" th:text="${taskList.name}">Nazwa listy</div>
                            </div>
                        </a>
                    </div>
                </div>
            </div>

            <!-- Link do dodawania nowej listy zada≈Ñ -->
            <a class="add-tasklist" th:href="@{/addTaskList}">Dodaj nowƒÖ listƒô zada≈Ñ</a>
        </div>
    </aside>

    <main class="main-content">
        <div class="Page-Title-Bar">
            <span class="page-title">
                Zadania <span th:text="${activeListName}">Domy≈õlna lista</span>
            </span>
        </div>

        <div class="search-bar">
            <input id="search" placeholder="Znajd≈∫ zadanie" />
            <span class="search-icon">&#128269;</span>
        </div>

        <a class="create-task-button" th:href="@{/addTaskPage}">Utw√≥rz nowe zadanie</a>

        <section class="task-display">
            <div th:if="${tasks != null}">
                <!-- Zadania -->
                <div th:each="task : ${tasks}"
                     class="task-item"
                     th:attr="data-task-id=${task.id}">
                    <div class="task-header">
                        <input type="checkbox"
                               class="task-checkbox"
                               th:checked="${task.status} == 'completed' ? true : false" />

                        <div class="name"
                             th:classappend="${task.status} == 'completed' ? ' completed' : ''"
                             th:text="${task.name}">Nazwa zadania</div>

                        <div class="due-date" th:text="${task.dueDate}">Data</div>

                        <div class="status"
                             th:text="${task.status} == 'completed' ? 'Zako≈Ñczone' : 'Do zrobienia'">Do zrobienia</div>

                        <button class="delete-task-button">üóëÔ∏è</button>
                    </div>
                    <div class="description" th:text="${task.description}">Opis zadania</div>
                </div>
            </div>
        </section>
    </main>
</div>

<template id="task-template">
    <div class="task-item" data-task-id="">
        <div class="task-header">
            <input type="checkbox" class="task-checkbox">
            <div class="name">Task Name</div>
            <div class="due-date">Due Date</div>
            <div class="status">Status</div>
            <button class="delete-task-button">üóëÔ∏è</button>
        </div>
        <div class="description">Task Description</div>
    </div>
</template>

<footer>
    <p>&copy; 2024 StudyFlow</p>
</footer>

<!-- Skrypt do obs≈Çugi checkbox (toggle) i kosza (usuwanie) przez REST -->
<script>
    document.addEventListener('DOMContentLoaded', function () {

        // 1) Stare klikanie, zmiana tytu≈Çu
        const taskLists = document.querySelectorAll('.TASKLIST');
        const pageTitle = document.querySelector('.page-title');
        taskLists.forEach(taskList => {
            taskList.addEventListener('click', function () {
                taskLists.forEach(tl => tl.classList.remove('selected'));
                this.classList.add('selected');
                const taskListName = this.querySelector('.name').textContent;
                pageTitle.textContent = 'Zadania ' + taskListName;
            });
        });

        // 2) Checkbox -> PATCH /api/tasks/<id>/toggle
        const checkboxes = document.querySelectorAll('.task-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.addEventListener('change', async (ev) => {
                const taskItem = ev.target.closest('.task-item');
                const taskId = taskItem.dataset.taskId;

                try {
                    const response = await fetch(`/api/tasks/${taskId}/toggle`, {
                        method: 'PATCH'
                    });
                    if (!response.ok) {
                        console.error('B≈ÇƒÖd toggle:', response.status);
                        // cofamy checkbox
                        ev.target.checked = !ev.target.checked;
                        return;
                    }
                    const newStatus = await response.text(); // "completed" / "todo"

                    // aktualizujemy w DOM
                    const nameDiv = taskItem.querySelector('.name');
                    const statusDiv = taskItem.querySelector('.status');
                    if (newStatus === 'completed') {
                        nameDiv.classList.add('completed');
                        statusDiv.textContent = 'Zako≈Ñczone';
                    } else {
                        nameDiv.classList.remove('completed');
                        statusDiv.textContent = 'Do zrobienia';
                    }
                } catch (e) {
                    console.error('Error toggleStatus:', e);
                    ev.target.checked = !ev.target.checked;
                }
            });
        });

        // 3) Usuwanie zadania -> DELETE /api/tasks/<id>
        const deleteButtons = document.querySelectorAll('.delete-task-button');
        deleteButtons.forEach(btn => {
            btn.addEventListener('click', async (ev) => {
                const taskItem = ev.target.closest('.task-item');
                const taskId = taskItem.dataset.taskId;

                if (!confirm('Na pewno usunƒÖƒá zadanie?')) {
                    return;
                }
                try {
                    const response = await fetch(`/api/tasks/${taskId}`, {
                        method: 'DELETE'
                    });
                    if (!response.ok) {
                        console.error('B≈ÇƒÖd usuwania:', response.status);
                        return;
                    }
                    // usu≈Ñ element z DOM
                    taskItem.remove();
                } catch(e) {
                    console.error('Error deleteTask:', e);
                }
            });
        });
    });
</script>

</body>
</html>
