<!DOCTYPE html>
<html lang="pl" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta name="description" content="Manage your tasks">
    <meta name="keywords" content="tasks, todo, list">
    <title>StudyFlow</title>

    <!-- CSS i skrypty stare, je≈õli nie przeszkadzajƒÖ -->
    <link rel="stylesheet" th:href="@{/css/stylehomePage.css}" />
    <script th:src="@{/js/logout.js}" defer></script>
    <script th:src="@{/js/search.js}" defer></script>
    <!-- WA≈ªNE: stary taskList.js lepiej ZAKOMENTUJ lub usu≈Ñ,
         bo on wywo≈Çuje /getTasks?id=..., co nie istnieje. -->
    <!-- <script th:src="@{/js/taskList.js}" defer></script> -->
    <script th:src="@{/js/changePassword.js}" defer></script>
</head>
<body>
<div id="TopBar">
    <img class="logo" th:src="@{/img/logo.svg}" alt="Logo">
    <div id="User-profile">
        <div class="User-profile2" onclick="logout(this)">
            <span class="Logout">Wyloguj siƒô</span>
        </div>
        <a class="User-profile2" th:href="@{/changePassword}">
            <span class="ChangePassword">Zmie≈Ñ has≈Ço</span>
        </a>
    </div>
</div>

<div id="container-page">
    <aside class="sidebar">
        <div class="tasklist-display">
            <h3>Twoje listy zada≈Ñ</h3>
            <div th:if="${taskLists != null}">
                <div th:each="taskList, iter : ${taskLists}">
                    <div class="home-blocks">
                        <a class="TASKLIST"
                           th:classappend="${iter.index} == 0 ? ' selected' : ''"
                           href="#"
                           th:attr="data-tasklist-id=${taskList.id}">
                            <div class="TASKLIST-choose">
                                <span class="tasklist-icon">&#x1F4CB;</span>
                                <div class="name" th:text="${taskList.name}">Nazwa listy</div>
                            </div>
                        </a>
                    </div>
                </div>
            </div>
            <a class="add-tasklist" th:href="@{/addTaskList}">Dodaj nowƒÖ listƒô zada≈Ñ</a>
        </div>
    </aside>

    <main class="main-content">
        <div class="Page-Title-Bar">
            <span class="page-title">
                Zadania <span th:text="${activeListName}">Domy≈õlna lista</span>
            </span>
        </div>
        <div class="search-bar">
            <input id="search" placeholder="Znajd≈∫ zadanie" />
            <span class="search-icon">&#128269;</span>
        </div>
        <a class="create-task-button" th:href="@{/addTaskPage}">Utw√≥rz nowe zadanie</a>

        <section class="task-display">
            <!-- Zadania wstƒôpnie wyrenderowane przez Thymeleaf -->
            <div th:if="${tasks != null}">
                <div th:each="task : ${tasks}"
                     class="task-item"
                     th:attr="data-task-id=${task.id}">
                    <div class="task-header">
                        <input type="checkbox"
                               class="task-checkbox"
                               th:checked="${task.status} == 'completed' ? true : false" />
                        <div class="name"
                             th:classappend="${task.status} == 'completed' ? ' completed' : ''"
                             th:text="${task.name}">Zadanie</div>
                        <div class="due-date" th:text="${task.dueDate}">Data</div>
                        <div class="status"
                             th:text="${task.status} == 'completed' ? 'Zako≈Ñczone' : 'Do zrobienia'"></div>
                        <button class="delete-task-button">üóëÔ∏è</button>
                    </div>
                    <div class="description" th:text="${task.description}">Opis</div>
                </div>
            </div>
        </section>
    </main>
</div>

<template id="task-template">
    <div class="task-item" data-task-id="">
        <div class="task-header">
            <input type="checkbox" class="task-checkbox">
            <div class="name">Task Name</div>
            <div class="due-date">Due Date</div>
            <div class="status">Status</div>
            <button class="delete-task-button">üóëÔ∏è</button>
        </div>
        <div class="description">Task Description</div>
    </div>
</template>

<footer>
    <p>&copy; 2024 StudyFlow</p>
</footer>

<script>
    document.addEventListener('DOMContentLoaded', function () {

        const pageTitle = document.querySelector('.page-title');
        const taskListLinks = document.querySelectorAll('.TASKLIST');

        // 1) KLIK W LISTƒò W SIDEBARZE
        taskListLinks.forEach(link => {
            link.addEventListener('click', async (ev) => {
                ev.preventDefault();
                // Styl .selected
                taskListLinks.forEach(l => l.classList.remove('selected'));
                link.classList.add('selected');

                // Nazwa + ID
                const listName = link.querySelector('.name').textContent;
                pageTitle.textContent = 'Zadania ' + listName;
                const listId = link.dataset.tasklistId;

                // fetch -> /api/tasks/tasklists/{listId}/tasks
                try {
                    const response = await fetch(`/api/tasks/tasklists/${listId}/tasks`);
                    if (!response.ok) {
                        console.error('B≈ÇƒÖd pobierania zada≈Ñ listy:', response.status);
                        return;
                    }
                    const tasks = await response.json();

                    // WYCZY≈öƒÜ OBECNE ZADANIA
                    const taskDisplay = document.querySelector('.task-display');
                    taskDisplay.innerHTML = '';

                    // UTW√ìRZ NOWE <div> dla ka≈ºdego zadania w JSON
                    for (const t of tasks) {
                        const itemDiv = document.createElement('div');
                        itemDiv.classList.add('task-item');
                        itemDiv.dataset.taskId = t.id;

                        const headerDiv = document.createElement('div');
                        headerDiv.classList.add('task-header');

                        // checkbox
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.classList.add('task-checkbox');
                        if (t.status === 'completed') {
                            checkbox.checked = true;
                        }

                        // name
                        const nameDiv = document.createElement('div');
                        nameDiv.classList.add('name');
                        nameDiv.textContent = t.name;
                        if (t.status === 'completed') {
                            nameDiv.classList.add('completed');
                        }

                        // due date
                        const dueDateDiv = document.createElement('div');
                        dueDateDiv.classList.add('due-date');
                        dueDateDiv.textContent = t.dueDate || '';

                        // status
                        const statusDiv = document.createElement('div');
                        statusDiv.classList.add('status');
                        statusDiv.textContent = (t.status === 'completed') ? 'Zako≈Ñczone' : 'Do zrobienia';

                        // kosz
                        const deleteBtn = document.createElement('button');
                        deleteBtn.classList.add('delete-task-button');
                        deleteBtn.textContent = 'üóëÔ∏è';

                        // sk≈Çadamy header
                        headerDiv.appendChild(checkbox);
                        headerDiv.appendChild(nameDiv);
                        headerDiv.appendChild(dueDateDiv);
                        headerDiv.appendChild(statusDiv);
                        headerDiv.appendChild(deleteBtn);

                        // opis
                        const descDiv = document.createElement('div');
                        descDiv.classList.add('description');
                        descDiv.textContent = t.description || '';

                        itemDiv.appendChild(headerDiv);
                        itemDiv.appendChild(descDiv);

                        // wstaw do .task-display
                        taskDisplay.appendChild(itemDiv);

                        // eventy:
                        checkbox.addEventListener('change', () => toggleTaskStatus(itemDiv));
                        deleteBtn.addEventListener('click', () => deleteTaskItem(itemDiv));
                    }
                } catch(e) {
                    console.error('B≈ÇƒÖd fetch:', e);
                }
            });
        });

        // 2) FUNKCJA: toggle status
        async function toggleTaskStatus(taskItem) {
            const taskId = taskItem.dataset.taskId;
            const checkbox = taskItem.querySelector('.task-checkbox');
            try {
                const resp = await fetch(`/api/tasks/${taskId}/toggle`, { method: 'PATCH' });
                if (!resp.ok) {
                    console.error('toggle error', resp.status);
                    checkbox.checked = !checkbox.checked;
                    return;
                }
                const newStatus = await resp.text();
                const nameDiv = taskItem.querySelector('.name');
                const statusDiv = taskItem.querySelector('.status');
                if (newStatus === 'completed') {
                    nameDiv.classList.add('completed');
                    statusDiv.textContent = 'Zako≈Ñczone';
                } else {
                    nameDiv.classList.remove('completed');
                    statusDiv.textContent = 'Do zrobienia';
                }
            } catch(e) {
                console.error('toggle exception', e);
                checkbox.checked = !checkbox.checked;
            }
        }

        // 3) FUNKCJA: usuniƒôcie zadania
        async function deleteTaskItem(taskItem) {
            if (!confirm('Na pewno usunƒÖƒá zadanie?')) return;
            const taskId = taskItem.dataset.taskId;
            try {
                const resp = await fetch(`/api/tasks/${taskId}`, { method: 'DELETE' });
                if (!resp.ok) {
                    console.error('delete error', resp.status);
                    return;
                }
                taskItem.remove();
            } catch(e) {
                console.error('delete exception', e);
            }
        }
    });
</script>
</body>
</html>
